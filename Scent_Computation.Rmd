---
title: "Test script"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
```

What do we need before doing this?

- File 1: An excel file of peak areas with a column of the compounds, and then a column for each sample. This does not include the toluene peak areas.
  + Check the compound names to make sure there are no duplicates and no spaces in the names
  + Put `Samp.` in front of all sample names to facilitate filtering/mutating
  + Put `Comp.` in front of all compound names to facilitate filtering/mutating
  + After `Comp.`, can use some kind of code in the compound names to assign compounds to a certain class or group. This would be useful for downstream steps where there's a need to pull out only compounds of some classes and mutate/work with them.
  
- File 2: An excel file of the meta-data with the following columns: `Sample_ID`, `Toluene_Area`, `Toluene_Amt`, `Sample_Vol`, `No_Hours`, `No_Flowers`, `Fresh_Mass`, `Dry.Mass`
  + `Sample_ID` values should match the column names associated with the samples in File 1.


Read in data with compounds in rows and samples as columns. Also read in the meta data file

```{r}
file1<-readxl::read_excel("Scent_Full.xlsx", na="0")
file1_rare<-readxl::read_excel("Scent_Rare.xlsx", na="0")
file1<-file1 %>% mutate_all(~replace(.,is.na(.), 0))
file1_rare<-file1_rare %>% mutate_all(~replace(.,is.na(.), 0))

file2<-readxl::read_excel("Scent_Meta.xlsx")

file3<-readxl::read_excel("Morph_Full.xlsx")

```


Try to generate column sums, and save them back to the object in a new row:
```{r}

Totals<-file1 %>% 
  bind_rows(summarise_all(., list(~if(is.numeric(.)) sum(.) else "Comp.Total"))) %>% 
  pivot_longer(cols=starts_with("Samp."),names_to="Sample_ID") %>% 
  pivot_wider(names_from=Compounds, values_from = value)

Totals_rare<-file1_rare %>% 
  bind_rows(summarise_all(., list(~if(is.numeric(.)) sum(.) else "Comp.Total"))) %>% 
  pivot_longer(cols=starts_with("Samp."),names_to="Sample_ID") %>% 
  pivot_wider(names_from=Compounds, values_from = value)

```

Creating relative amounts data frame:

```{r}

percent <- function(x) { round((x/sum(x)) * 100, digits=3)
}

Percents<-file1 %>% 
  mutate_at(vars(starts_with("Samp.")), percent)

Percents_wide <- Percents %>% 
  pivot_longer(cols=starts_with("Samp."),names_to="Sample_ID") %>% 
  pivot_wider(names_from=Compounds, values_from = value) %>% 
  full_join(file2)

```




Now using the ID information, to be able to calculate emission rates
```{r}

#These functions specify how to calculate what we want: total scent in the sample, and emission rates per flower, per fresh mass, and per dry mass:
T_S<-function(Column, Tol.Area, Tol.Amt, Samp.Vol) {
  Column/Tol.Area*Tol.Amt*Samp.Vol
} 

ER_Fl<-function(Total.Samp, Hrs, Flwrs) {
  Total.Samp/Hrs/Flwrs
}

ER_Fm<-function(Total.Samp, Hrs, Fr.Mass) {
  Total.Samp/Hrs/Fr.Mass
}

ER_Dm<-function(Total.Samp, Hrs, Dr.Mass) {
  Total.Samp/Hrs/Dr.Mass
}

Total_Samples<-Totals %>%  full_join(file2) %>% 
  mutate_at(vars(starts_with("Comp.")), list(~T_S(.,Toluene_Area,Toluene_Amt, Sample_Vol))) 


Total_Samples_rare<-Totals_rare %>%  full_join(file2) %>% 
  mutate_at(vars(starts_with("Comp.")), list(~T_S(.,Toluene_Area,Toluene_Amt, Sample_Vol))) 

ER_flowers<-Total_Samples %>% 
  mutate_at(vars(starts_with("Comp.")), list(~ER_Fl(.,No_Hours, No_Flowers))) 

ER_f_mass<-Total_Samples %>% 
  mutate_at(vars(starts_with("Comp.")), list(~ER_Fm(.,No_Hours, Fresh_Mass))) 

ER_f_mass_rare<-Total_Samples_rare %>% 
  mutate_at(vars(starts_with("Comp.")), list(~ER_Fm(.,No_Hours, Fresh_Mass))) 

ER_d_mass<-Total_Samples %>% 
  mutate_at(vars(starts_with("Comp.")), list(~ER_Dm(.,No_Hours, Dry_Mass))) 

```



