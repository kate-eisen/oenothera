---
title: "Oenothera analyses, updated Dec 28 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Questions we are exploring

Do floral traits vary across populations?

If floral traits vary across populations, are patterns of variation clinal, associated with variation in pollinators, or random?

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# need the relevant code from test script in order to be able to knit this file

library(tidyverse)
library(readxl)
library(lme4)
library(lmerTest)
library(emmeans)
library(vegan)
library(knitr)
library(reshape2)
library(ggpubr)

file1<-readxl::read_excel("Scent_Full.xlsx", na="0")
file1<-file1 %>% mutate_all(~replace(.,is.na(.), 0))

file2<-readxl::read_excel("Scent_Meta.xlsx")

file3<-readxl::read_excel("Morph_Full.xlsx")

Totals<-file1 %>% 
  bind_rows(summarise_all(., list(~if(is.numeric(.)) sum(.) else "Comp.Total"))) %>% 
  pivot_longer(cols=starts_with("Samp."),names_to="Sample_ID") %>% 
  pivot_wider(names_from=Compounds, values_from = value)

percent <- function(x) { round((x/sum(x)) * 100, digits=3)
}

Percents<-file1 %>% 
  mutate_at(vars(starts_with("Samp.")), percent)

Percents_wide <- Percents %>% 
  pivot_longer(cols=starts_with("Samp."),names_to="Sample_ID") %>% 
  pivot_wider(names_from=Compounds, values_from = value) %>% 
  full_join(file2)

T_S<-function(Column, Tol.Area, Tol.Amt, Samp.Vol) {
  Column/Tol.Area*Tol.Amt*Samp.Vol
} 

ER_Fm<-function(Total.Samp, Hrs, Fr.Mass) {
  Total.Samp/Hrs/Fr.Mass
}

Total_Samples<-Totals %>%  full_join(file2) %>% 
  mutate_at(vars(starts_with("Comp.")), list(~T_S(.,Toluene_Area,Toluene_Amt, Sample_Vol))) 

ER_f_mass<-Total_Samples %>% 
  mutate_at(vars(starts_with("Comp.")), list(~ER_Fm(.,No_Hours, Fresh_Mass))) 

get_upper_tri <- function(cormat){
    cormat[lower.tri(cormat)]<- NA
    return(cormat)
  }

```






## Analysis approach

*Overall*, we are investigating whether differences between populations occur in floral morphology, floral scent, or a combination of the two.

(To facilitate our analyses, we reduced the number of floral scent variables under investigation by combining correlated compounds that are produced via the same biosynthetic pathways. I will make a supplement/appendix for the paper that shows how we did that.)

To start, we use multivariate approaches that use the morphology variables, the scent variables, or both, and see how much of the total variance those sets of variables explain.

Then, we can unpack which variables in particular are different across populations.

**There are kind of two different questions here--(1) what does a better job, scent, morphology, or both? and then (2) within scent and or morphology, what actually matters?

## Analysis of scent

Total emission rate and compound diversity are two variables that are essentially summaries of the whole scent dataset, so they won't be included in the multivariate analyses, but will be analyzed regardless of the outcomes of the multivariate analyses.

### Total emission rate

This is total emission rate (per g fresh mass) as a function of population, with plant nested within population as a random effect. So this makes use of all measured flowers.

```{r, echo=FALSE}
ER_f_mass <- ER_f_mass %>% filter(ER_f_mass$Population!="Idaho")
ER_f_mass$Population<-factor(ER_f_mass$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

total.model<-lmer(Comp.Total~Population+(1|Pop_Plant), data=ER_f_mass)
```

Diagnostics for the model residuals:

```{r, echo=FALSE}
hist(resid(total.model))
plot(predict(total.model),resid(total.model)) 
```

ANOVA:
```{r, echo=FALSE}
anova(total.model)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(total.model, pairwise~Population, type="response")

a<-emmip(total.model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Total scent emission (estimated marginal mean)")+mdthemes::md_theme_classic()
```

**Interpretation**: total scent shows a roughly clinal pattern. Due to the amount of variance, the significant contrasts are that Logan has lower total scent than Inyo or Arizona. Zion is intermediate.

### Compound diversity

This is the number of compounds detected in a sample as a function of population, with plant nested within population as a random effect. So this makes use of all measured flowers.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Removing the scent samples that had no compounds detected:
Percents_names <- Percents_wide %>% 
  filter(Comp.2methylbutyronitrile!="NaN") 

#Making a P/A matrix of just the compounds
P_A<-Percents_names %>% select(starts_with("Comp."))
P_A[P_A>0]<-1

#Calculating the total number of compounds in each sample
P_A_totals <- P_A %>%  mutate(Total=rowSums(.)) %>% cbind(., Population=Percents_names$Population, Pop_Plant=Percents_names$Pop_Plant) %>% filter(Population!="Idaho")

#Ordering the levels of Population according to latitude

P_A_totals$Population<-factor(P_A_totals$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

#Modeling the total number of compounds in each sample:
totals.model<-lmer(Total~Population+(1|Pop_Plant), data=P_A_totals)
```

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
hist(resid(totals.model))
plot(predict(totals.model),resid(totals.model))
```

ANOVA:
```{r, echo=FALSE}
anova(totals.model)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(totals.model, pairwise~Population, type="response")

b<-emmip(totals.model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Number of compounds (estimated marginal mean)")+mdthemes::md_theme_classic()

ggarrange(a,b)
```



**Interpretation**: The total number of compounds also shows a clinal pattern. The significant contrasts are that Logan has fewer compounds than Inyo and Arizona. 


### Floral scent blend composition, multivariate analyses using groupings by biosynthetic pathway

*Note*: these results could change once we are working with emission rates adjusted for response factors

These are the groupings of the compounds (ver. 2.0):

| Code | Compounds
| :--- | :--------
| G.ILE | 2 methylbuyronitrile, nitro-2-methyl butane, cis-2-methylbutyraldoxime, trans-2-methylbutyraldoxime 
| G.LEU | 3methylbutyronitrile, nitro-3-methyl-butane, cis-3-methylbutyraldoxime, trans-3-methylbutyraldoxime, cis-isobutyraldoxime, trans-isobutyraldoxime
| G.PHE | 2phenylethanol, phenylacetonitrile, nitrophenylethane, phenylacetaldoxime
| G.OCI | b-myrcene, cis-b-ocimene, trans-b-ocimene 
| G.GER | citronellol, neral, geranial, nerol, geraniol
| G.LIN | linalool
| G.LOX | cis-furanoid-linalool-oxide, trans-furanoid-linalool-oxide, pyran-lin-oxide-ketone, cis-pyranoid-linalool-oxide, trans-pyranoid-linalool-oxide
| G.CAR | beta-caryophyllene, alpha-humulene, caryophyllene-oxide, farnesol
| G.NER | nerolidol
| G.ISO | isophytol
| G.ALT | alpha-terpineol
| G.FAR | beta-farnesene, Z-E-alpha-farnesene, E-E-alpha-farnesene, farnesene-epoxide

First, running an adonis (comparable to ANOSIM):
```{r, echo=FALSE, warning=FALSE, message=FALSE}
#working with ER_f_mass (for now at least), and creating new variables by combining the emission rates of compounds from the same pathway.

#the pathway assignments came from Rob

ER_f_mass_groups <- ER_f_mass %>% filter(Type=="Yes") %>%  mutate(G.ILE=Comp.2methylbutyronitrile+`Comp.nitro-2-methyl-butane`+`Comp.cis-2-methylbutyraldoxime`+`Comp.trans-2-methylbutyraldoxime`,
                                         G.LEU=Comp.3methylbutyronitrile+`Comp.nitro-3-methyl-butane`+`Comp.cis-3-methylbutyraldoxime`+`Comp.trans-3-methylbutyraldoxime`+`Comp.cis-isobutyraldoxime`+`Comp.trans-isobutyraldoxime`,
                                        
                                         G.PHE=Comp.2phenylethanol+Comp.phenylacetonitrile+Comp.nitrophenylethane+Comp.phenylacetaldoxime,
                                         G.OCI=`Comp.b-myrcene`+`Comp.cis-b-ocimene`+`Comp.trans-b-ocimene`,
                                         G.GER=Comp.citronellol+Comp.neral+Comp.geranial+Comp.nerol+Comp.geraniol,
                                         G.LIN=Comp.linalool,
                                         G.LOX=`Comp.cis-furanoid-linalool-oxide`+`Comp.trans-furanoid-linalool-oxide`+`Comp.pyran-lin-oxide-ketone`+`Comp.cis-pyranoid-linalool-oxide`+`Comp.trans-pyranoid-linalool-oxide`,
                                         G.CAR=`Comp.beta-caryophyllene`+`Comp.alpha-humulene`+`Comp.caryophyllene-oxide`+Comp.farnesol,
                                         G.FAR=`Comp.beta-farnesene`+`Comp.Z-E-alpha-farnesene`+`Comp.E-E-alpha-farnesene`+`Comp.farnesene-epoxide`,
                                         G.NER=Comp.nerolidol,
                                         G.ISO=Comp.isophytol,
                                         G.ALT=`Comp.alpha-terpineol`)

ER_f_mass_group_data <- ER_f_mass_groups %>% filter(Population!="Idaho") %>%  select(starts_with("G."))

ER_f_mass_group_data <- ER_f_mass_group_data %>% slice(.,-c(36,44))
ER_f_mass_groups <- ER_f_mass_groups %>% filter(Population!="Idaho") %>% slice(.,-c(36,44))
  

groups.adonis <- adonis(ER_f_mass_group_data~Population, data=ER_f_mass_groups,permutations=999, method="bray" )

groups.adonis

```

*Interpretation*: The adonis shows a significant effect of population, which explains about 23 % of the variance in scent blend composition.

Running a constrained analysis of principle coordinates:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
scents.cap <- capscale(ER_f_mass_group_data ~ Population, ER_f_mass_groups, dist="bray") 
summary(scents.cap, display=NULL)
```
The constrained portion explains about 21% of overall distance. CAP1 explains about 19% and CAP2 expalins about 1% of overall distance. *I suggest this means we should really be looking at the compounds that are correlated with CAP1*

Plotting the capscale:

```{r, echo=FALSE, warning=FALSE, message=FALSE}

scores<-as.data.frame(scores(scents.cap, display="sites"))
Percent_names_scores<-cbind(ER_f_mass_groups, scores)
arrows.a<-as.data.frame(scores(scents.cap, display="species"))
arrows.a<-arrows.a[c(1,2,4,6,9,12),]

a<-ggplot(aes(x=CAP1, y=CAP2), data=Percent_names_scores) +geom_point(aes(color=Population), size=3, shape=15) + theme_classic()+geom_hline(yintercept = 0, linetype="dashed")+ geom_vline(xintercept = 0, linetype="dashed") +ggtitle("Scent data")+geom_segment(aes(x=0, y=0, xend=CAP1*1.25, yend=CAP2*1.25), data=arrows.a, arrow = arrow(length = unit(0.25, "cm")))+geom_text(aes(x=(CAP1*1.25)+0.1, y=(CAP2*1.25)+0.1, label=rownames(arrows.a)), data=arrows.a)


#+geom_segment(aes(x=0,y=0,xend=CAP1*2, yend=CAP2*2), data=arrows)

```


Checking to see which compound group(s) are significantly correlated with CAP1 and/or CAP2.
```{r, echo=FALSE, warning=FALSE, message=FALSE}

scores<-as.data.frame(scores(scents.cap, display="sites"))


Percent_names_scores<-cbind(ER_f_mass_group_data, scores)

cors <- as.data.frame(sapply(1:12,function(x) cor.test(Percent_names_scores[,x],Percent_names_scores$CAP1)))

cors2 <- as.data.frame(sapply(1:12,function(x) cor.test(Percent_names_scores[,x],Percent_names_scores$CAP2)))
pvals<-sapply(1:12,function(x) cors[,x]$p.value)
pvals2<-sapply(1:12,function(x) cors2[,x]$p.value)
pvals.a<-round(p.adjust(pvals, method="BH"), 4)
pvals.a2<-round(p.adjust(pvals2, method="BH"), 4)


co1<-sapply(1:12,function(x) round(cors[,x]$estimate,4))
co2<-sapply(1:12,function(x) round(cors2[,x]$estimate,4))


compounds<-colnames(ER_f_mass_group_data)

c.table<-as.data.frame(cbind(compounds,cor1=co1,p1=pvals.a,cor2=co2, p2=pvals.a2))
c.table$p1<-as.numeric(as.character(c.table$p1))
c.table$p2<-as.numeric(as.character(c.table$p2))
c.table$sig1<-rep("No", times=dim(c.table)[1])
c.table$sig2<-rep("No", times=dim(c.table)[1])
c.table$sig1<-ifelse(c.table$p1 < 0.01, "Yes", c.table$sig1)
c.table$sig2<-ifelse(c.table$p2 < 0.01, "Yes", c.table$sig2)
rownames(c.table)<-c()

kable(c.table)

```

This table indicates that four compound groups are correlated with CAP1 at P adjusted < 0.01 : ILE, LEU, LIN, ALT. Two compound groups are correlated with CAP2: OCI, FAR.


### Floral scent, univariate analyses of key compound groups

*Note*: these results could change once we are working with emission rates adjusted for response factors. 

For each compound group that was correlated with CAP1 and/or CAP2, the emission rate is modeled as a function of population, with plant nested within population as a random effect. This uses data from all measured flowers. 

```{r}
ER_f_mass_groups <- ER_f_mass %>% mutate(G.ILE=Comp.2methylbutyronitrile+`Comp.nitro-2-methyl-butane`+`Comp.cis-2-methylbutyraldoxime`+`Comp.trans-2-methylbutyraldoxime`,
                                         G.LEU=Comp.3methylbutyronitrile+`Comp.nitro-3-methyl-butane`+`Comp.cis-3-methylbutyraldoxime`+`Comp.trans-3-methylbutyraldoxime`+`Comp.cis-isobutyraldoxime`+`Comp.trans-isobutyraldoxime`,
                                        
                                         G.PHE=Comp.2phenylethanol+Comp.phenylacetonitrile+Comp.nitrophenylethane+Comp.phenylacetaldoxime,
                                         G.OCI=`Comp.b-myrcene`+`Comp.cis-b-ocimene`+`Comp.trans-b-ocimene`,
                                         G.GER=Comp.citronellol+Comp.neral+Comp.geranial+Comp.nerol+Comp.geraniol,
                                         G.LIN=Comp.linalool,
                                         G.LOX=`Comp.cis-furanoid-linalool-oxide`+`Comp.trans-furanoid-linalool-oxide`+`Comp.pyran-lin-oxide-ketone`+`Comp.cis-pyranoid-linalool-oxide`+`Comp.trans-pyranoid-linalool-oxide`,
                                         G.CAR=`Comp.beta-caryophyllene`+`Comp.alpha-humulene`+`Comp.caryophyllene-oxide`+Comp.farnesol,
                                         G.FAR=`Comp.beta-farnesene`+`Comp.Z-E-alpha-farnesene`+`Comp.E-E-alpha-farnesene`+`Comp.farnesene-epoxide`,
                                         G.SES=Comp.nerolidol+Comp.isophytol,
                                         G.NER=Comp.nerolidol,
                                         G.ISO=Comp.isophytol,
                                         G.ALT=`Comp.alpha-terpineol`)

ER_f_mass_group_data <- ER_f_mass_groups %>% select(starts_with("G."))

ER_f_mass_group_data <- ER_f_mass_group_data %>% slice(.,-c(36,44))
ER_f_mass_groups <- ER_f_mass_groups %>% slice(.,-c(36,44))
```



**ILE group**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ER_f_mass_groups$Population<-factor(ER_f_mass_groups$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(G.ILE~Population+(1|Pop_Plant), data=ER_f_mass_groups)
hist(resid(model))
plot(predict(model),resid(model))
```


ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```
**The differences between populations are not significant after controlling for doing six tests.**


```{r, echo=FALSE, warning=FALSE, message=FALSE}
#emmeans(model, pairwise~Population, type="response")

#emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Total scent emission of ILE compounds (estimated marginal mean)")+mdthemes::md_theme_classic()
```


**LEU group**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ER_f_mass_groups$Population<-factor(ER_f_mass_groups$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(G.LEU~Population+(1|Pop_Plant), data=ER_f_mass_groups)
hist(resid(model))
plot(predict(model),resid(model))
```

Untransformed residuals look okay, square root transformation (not shown) is comparable and doesn't affect the results.


ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

a<-emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Emission rate of LEU compounds")+mdthemes::md_theme_classic()
```

*Interpretation*: Inyo and Arizona have higher emission rates of LEU compounds relative to Logan.

**linalool**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ER_f_mass_groups$Population<-factor(ER_f_mass_groups$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(G.LIN~Population+(1|Pop_Plant), data=ER_f_mass_groups)
hist(resid(model))
plot(predict(model),resid(model))
```

Untransformed residuals look okay, square root transformation (not shown) is comparable and doesn't affect the results.

ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

b<-emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Emission rate of linalool")+mdthemes::md_theme_classic()
```

*Interpretation*: Inyo and Arizona emit more linalool than Logan. 

**alpha terpineol**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ER_f_mass_groups$Population<-factor(ER_f_mass_groups$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(sqrt(G.ALT)~Population+(1|Pop_Plant), data=ER_f_mass_groups)
hist(resid(model))
plot(predict(model),resid(model))
```

Square-root transformation applied to improve residuals.


ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

c<-emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Emission rate of alpha-terpineol")+mdthemes::md_theme_classic()

ggarrange(a,b,c, nrow=1, ncol=3)
```

*Interpretation*: Arizona has higher emission rates of alpha terpineol than all other populations. 

**FAR group--correlated with CAP2**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ER_f_mass_groups$Population<-factor(ER_f_mass_groups$Population, levels=c( "Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(G.FAR~Population+(1|Pop_Plant), data=ER_f_mass_groups)
hist(resid(model))
plot(predict(model),resid(model))
```

ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

**The differences between populations are not significant after controlling for doing six tests.**


```{r, echo=FALSE, warning=FALSE, message=FALSE}
#emmeans(model, pairwise~Population, type="response")

#emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Total scent emission of CAR compounds (estimated marginal mean)")+mdthemes::md_theme_classic()
```

**OCI group--correlated with CAP2**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}

ER_f_mass_groups$Population<-factor(ER_f_mass_groups$Population, levels=c( "Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(G.OCI~Population+(1|Pop_Plant), data=ER_f_mass_groups)
hist(resid(model))
plot(predict(model),resid(model))
```

ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

No differences across populations.

### Floral morphology, multivariate analyses

In order to do multivariate analyses of the morphological variables, I had to drop leaf number and leaf length, because there isn't enough data.

```{r, echo=FALSE}
morph_data <- file3 %>%  filter(Population!="Idaho"& Type=="Yes") %>% select(starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% mutate(M.Herkogamy=M.Stamen_Length-M.Style_Length) %>% select(-M.Stamen_Length, -M.Style_Length) %>%  drop_na() 

morph_names <- file3 %>% filter(Population!="Idaho"& Type=="Yes") %>% select(starts_with("M."), Population, Pop_Plant) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% mutate(M.Herkogamy=M.Stamen_Length-M.Style_Length) %>% select(-M.Stamen_Length, -M.Style_Length) %>% drop_na()

morph.adonis <- adonis(morph_data~Population, data=morph_names, permutations=999, method="bray")
morph.adonis
```
*Interpretation*: There is a significant effect of Population. It explains about 39 % of the variation in morphology.

Running a constrained analysis of principle coordinates:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph.cap <- capscale(morph_data ~ Population, morph_names, dist="bray") 
summary(morph.cap, display=NULL)
```
The constrained portion explains about 33% of overall distance. CAP1 explains about 27% and CAP2 expalins about 6% of overall distance.

Plotting the capscale:

```{r, echo=FALSE, warning=FALSE, message=FALSE}

scores<-as.data.frame(scores(morph.cap, display="sites"))
Percent_names_scores<-cbind(morph_names, scores)
arrows.b<-as.data.frame(scores(morph.cap, display="species"))
arrows.b<-arrows.b[c(-1,-8),]

b<-ggplot(aes(x=CAP1, y=CAP2), data=Percent_names_scores) +geom_point(aes(color=Population), size=3, shape=15) + theme_classic()+geom_hline(yintercept = 0, linetype="dashed")+ geom_vline(xintercept = 0, linetype="dashed")+ggtitle("Morphology data") +geom_segment(aes(x=0, y=0, xend=CAP1*1.25, yend=CAP2*1.25), data=arrows.b, arrow = arrow(length = unit(0.25, "cm")))+geom_text(aes(x=(CAP1*1.25)+0.1, y=(CAP2*1.25)+0.1, label=rownames(arrows.b)), data=arrows.b)



#+geom_segment(aes(x=0,y=0,xend=CAP1*2, yend=CAP2*2), data=arrows)

```


Checking to see which traits are significantly correlated with CAP1 and/or CAP2.
```{r, echo=FALSE, warning=FALSE, message=FALSE}

scores<-as.data.frame(scores(morph.cap, display="sites"))


Percent_names_scores<-cbind(morph_data, scores)

cors <- as.data.frame(sapply(1:8,function(x) cor.test(Percent_names_scores[,x],Percent_names_scores$CAP1)))

cors2 <- as.data.frame(sapply(1:8,function(x) cor.test(Percent_names_scores[,x],Percent_names_scores$CAP2)))
pvals<-sapply(1:8,function(x) cors[,x]$p.value)
pvals2<-sapply(1:8,function(x) cors2[,x]$p.value)
pvals.a<-round(p.adjust(pvals, method="BH"),4)
pvals.a2<-round(p.adjust(pvals2, method="BH"),4)


co1<-sapply(1:8,function(x) round(cors[,x]$estimate,4))
co2<-sapply(1:8,function(x) round(cors2[,x]$estimate,4))


variables<-colnames(morph_data)

c.table<-as.data.frame(cbind(variables,cor1=co1,p1=pvals.a,cor2=co2, p2=pvals.a2))
c.table$p1<-as.numeric(as.character(c.table$p1))
c.table$p2<-as.numeric(as.character(c.table$p2))
c.table$sig1<-rep("No", times=dim(c.table)[1])
c.table$sig2<-rep("No", times=dim(c.table)[1])
c.table$sig1<-ifelse(c.table$p1 < 0.01, "Yes", c.table$sig1)
c.table$sig2<-ifelse(c.table$p2 < 0.01, "Yes", c.table$sig2)
rownames(c.table)<-c()

kable(c.table)

```

From this, all variables except for pedicel length and Corolla D1 are correlated with CAP1, and all of them are positively correlated.

The only variables correlated with CAP2 are hypanthium length (negative) and pedicel length (positive).

### Floral morphology, univariate analyses

Looking at all nine floral morphology variables, as all were correlated with CAP1 and/or CAP2. Each variable is modeled as a function of population, with plant nested within population as a random effect. This uses data from all measured flowers where all variables were measured on the flower.

**Corolla D2**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_data <- file3 %>%  filter(Population!="Idaho") %>% select(starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na() 

morph_names <- file3 %>% filter(Population!="Idaho") %>% select(starts_with("M."), Population, Pop_Plant) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()

morph_names$Population<-factor(morph_names$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(M.Corolla_D2~Population+(1|Pop_Plant), data=morph_names)
hist(resid(model))
plot(predict(model),resid(model))
```


ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

a<-emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Estimated marginal mean")+mdthemes::md_theme_classic()+ggtitle("corolla dimension 2")
```

*Interpretation*: Zion has a significantly larger corolla dimension 2 relative to all other populations. Inyo and Arizona have the next largest corolla D2, which is larger than Logan. 

**Tube Flare**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_names$Population<-factor(morph_names$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(M.Tube_Flare~Population+(1|Pop_Plant), data=morph_names)
hist(resid(model))
plot(predict(model),resid(model))
```

ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

b<-emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Estimated marginal mean")+mdthemes::md_theme_classic()+ggtitle("tube flare")
```

*Interpretation*: Zion is equal to Inyo, but greater than Arizona or Logan. Inyo is equal to Arizona, and greater than Logan. Arizona and Logan are equivalent.

**Stamen Length**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_names$Population<-factor(morph_names$Population, levels=c( "Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(M.Stamen_Length~Population+(1|Pop_Plant), data=morph_names)
hist(resid(model))
plot(predict(model),resid(model))
```


ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=8)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Stamen length (estimated marginal mean)")+mdthemes::md_theme_classic()
```

*Interpretation*: Zion has longer stamens then all other populations. Inyo has longer stamens than Logan and Arizona. Logan and Arizona have comparable stamens.


**Style Length**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_names$Population<-factor(morph_names$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(M.Style_Length~Population+(1|Pop_Plant), data=morph_names)
hist(resid(model))
plot(predict(model),resid(model))
```

ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=8)
```

Estimated marginal means & contrasts across populations:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Style length (estimated marginal mean)")+mdthemes::md_theme_classic()
```

*Interpretation*: Zion has longer styles then all other populations. Inyo has longer styles than Logan and Arizona.  Logan and Arizona  have comparable styles.

**Hypanthium Length**:

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_names$Population<-factor(morph_names$Population, levels=c( "Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(M.Hypanthium_Length~Population+(1|Pop_Plant), data=morph_names)
hist(resid(model))
plot(predict(model),resid(model))
```

It looks like there is one outlier: rm2-28 (Arizona) the fifth flower, measured on 6/19. It has a length of 36.48, but the other four flowers from the plant all have lengths over 100. I suspect that the 100 digit may have been dropped from this measurement. Can we either resolve this from the paper datasheet or remove this outlier?

ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)

```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

c<-emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Estimated marginal mean")+mdthemes::md_theme_classic()+ggtitle("hypanthium length")
```

*Interpretation*: Logan is lower than the other three populations, which are comparable.

**Pedicel length**:

*Note*: there are some potential outliers/zeros values that maybe should be NAs in the dataset right now.

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_names$Population<-factor(morph_names$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(M.Pedicel_Length~Population+(1|Pop_Plant), data=morph_names)
hist(resid(model))
plot(predict(model),resid(model))
```


ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

d<-emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Estimated marginal mean")+mdthemes::md_theme_classic()+ggtitle("pedicel length")
```

*Interpretation*: The only significant contrasts are that Logan and Zion have larger pedicel lengths than Arizona.

**Nectar column**:

*Note*: there are some potential outliers/zeros values that maybe should be NAs in the dataset right now.

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_names$Population<-factor(morph_names$Population, levels=c( "Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(M.Nectar_Column~Population+(1|Pop_Plant), data=morph_names)
hist(resid(model))
plot(predict(model),resid(model))
```


ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6)
```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

e<-emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Estimated marginal mean")+mdthemes::md_theme_classic()+ggtitle("nectar tube length")

ggarrange(a,b,c,d,e)
```

*Interpretation*: Logan is lower than Arizona and Inyo.

**Percent sugar**:

*Note*: there are some potential outliers/zeros values that maybe should be NAs in the dataset right now.

Diagnostics for the model residuals:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_names$Population<-factor(morph_names$Population, levels=c( "Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(M.Percent_Sugar~Population+(1|Pop_Plant), data=morph_names)
hist(resid(model))
plot(predict(model),resid(model))
```


ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=6
         )
```

Differences across populations are not significant.


### Multivariate analysis of scent and morphology together

```{r, echo=FALSE, warning=FALSE, message=FALSE}


morph_names <- file3 %>% select(starts_with("M."), Population, Pop_Plant, Sample_ID, Type) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% mutate(M.Herkogamy=M.Stamen_Length-M.Style_Length) %>% select(-M.Stamen_Length, -M.Style_Length) %>% filter(Type=="Yes")

ER_f_mass_groups <- ER_f_mass_groups %>% select(starts_with("G."), Population, Pop_Plant, Sample_ID, Type) %>% filter(Type=="Yes")

All_data_names <- full_join(ER_f_mass_groups, morph_names) %>% filter(Population!="Idaho") %>%  drop_na()
All_data <- All_data_names %>%  select(starts_with("M."), starts_with("G."))


All.adonis <- adonis(All_data~Population, data=All_data_names,permutations=999, method="bray")
All.adonis
```

Population explains about 28 % of the variation in percent composition of floral scent and in morphology. (As a reminder, population explained about 23 % of variation in the scent only dataset, and about 39 % of variation in the morphology only dataset.)

Running a constrained analysis of principle coordinates:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph.cap2 <- capscale(All_data ~ Population, All_data_names, dist="bray") 
summary(morph.cap2, display=NULL)
```
The constrained portion explains about 26% of overall distance. CAP1 explains about 24% and CAP2 expalins about 1.5% of overall distance.

Plotting the capscale:

```{r, echo=FALSE, warning=FALSE, message=FALSE}

scores<-as.data.frame(scores(morph.cap2, display="sites"))
Percent_names_scores<-cbind(All_data_names, scores)
arrows.c<-as.data.frame(scores(morph.cap2, display="species"))
arrows.c<-arrows.c[c(4,9,10,14),]

c<-ggplot(aes(x=CAP1, y=CAP2), data=Percent_names_scores) +geom_point(aes(color=Population), size=3, shape=15) + theme_classic()+geom_hline(yintercept = 0, linetype="dashed")+ geom_vline(xintercept = 0, linetype="dashed") +ggtitle("Combined data")+geom_segment(aes(x=0, y=0, xend=CAP1*1.25, yend=CAP2*1.25), data=arrows.c, arrow = arrow(length = unit(0.25, "cm")))+geom_text(aes(x=(CAP1*1.25)+0.1, y=(CAP2*1.25)+0.1, label=rownames(arrows.c)), data=arrows.c)


#+geom_segment(aes(x=0,y=0,xend=CAP1*2, yend=CAP2*2), data=arrows)
ggarrange(a,b,c, nrow=3,ncol=1,common.legend = TRUE)
```


Checking to see which compound group(s) are significantly correlated with CAP1 and/or CAP2.
```{r, echo=FALSE, warning=FALSE, message=FALSE}

scores<-as.data.frame(scores(morph.cap2, display="sites"))


Percent_names_scores<-cbind(All_data, scores)

cors <- as.data.frame(sapply(1:20,function(x) cor.test(Percent_names_scores[,x],Percent_names_scores$CAP1)))

cors2 <- as.data.frame(sapply(1:20,function(x) cor.test(Percent_names_scores[,x],Percent_names_scores$CAP2)))
pvals<-sapply(1:20,function(x) cors[,x]$p.value)
pvals2<-sapply(1:20,function(x) cors2[,x]$p.value)
pvals.a<-round(p.adjust(pvals, method="BH"),4)
pvals.a2<-round(p.adjust(pvals2, method="BH"),4)


co1<-sapply(1:20,function(x) round(cors[,x]$estimate,4))
co2<-sapply(1:20,function(x) round(cors2[,x]$estimate,4))


variables<-colnames(All_data)

c.table<-as.data.frame(cbind(variables,cor1=co1,p1=pvals.a,cor2=co2, p2=pvals.a2))
c.table$p1<-as.numeric(as.character(c.table$p1))
c.table$p2<-as.numeric(as.character(c.table$p2))
c.table$sig1<-rep("No", times=dim(c.table)[1])
c.table$sig2<-rep("No", times=dim(c.table)[1])
c.table$sig1<-ifelse(c.table$p1 < 0.01, "Yes", c.table$sig1)
c.table$sig2<-ifelse(c.table$p2 < 0.01, "Yes", c.table$sig2)
rownames(c.table)<-c()

kable(c.table)

```

Correlated with CAP 1: Hypanthium Length (+), ILE (+), LEU (+), LIN (+)


Correlated with CAP 2: LEU (-), LIN (-)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
morph_names <- file3 %>% select(starts_with("M."), Population, Pop_Plant, Sample_ID, Type) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% mutate(M.Herkogamy=M.Stamen_Length-M.Style_Length) %>% select(-M.Stamen_Length, -M.Style_Length) 

ER_f_mass_groups <- ER_f_mass %>% mutate(G.ILE=Comp.2methylbutyronitrile+`Comp.nitro-2-methyl-butane`+`Comp.cis-2-methylbutyraldoxime`+`Comp.trans-2-methylbutyraldoxime`,
                                         G.LEU=Comp.3methylbutyronitrile+`Comp.nitro-3-methyl-butane`+`Comp.cis-3-methylbutyraldoxime`+`Comp.trans-3-methylbutyraldoxime`+`Comp.cis-isobutyraldoxime`+`Comp.trans-isobutyraldoxime`,
                                        
                                         G.PHE=Comp.2phenylethanol+Comp.phenylacetonitrile+Comp.nitrophenylethane+Comp.phenylacetaldoxime,
                                         G.OCI=`Comp.b-myrcene`+`Comp.cis-b-ocimene`+`Comp.trans-b-ocimene`,
                                         G.GER=Comp.citronellol+Comp.neral+Comp.geranial+Comp.nerol+Comp.geraniol,
                                         G.LIN=Comp.linalool,
                                         G.LOX=`Comp.cis-furanoid-linalool-oxide`+`Comp.trans-furanoid-linalool-oxide`+`Comp.pyran-lin-oxide-ketone`+`Comp.cis-pyranoid-linalool-oxide`+`Comp.trans-pyranoid-linalool-oxide`,
                                         G.CAR=`Comp.beta-caryophyllene`+`Comp.alpha-humulene`+`Comp.caryophyllene-oxide`+Comp.farnesol,
                                         G.FAR=`Comp.beta-farnesene`+`Comp.Z-E-alpha-farnesene`+`Comp.E-E-alpha-farnesene`+`Comp.farnesene-epoxide`,
                                         G.SES=Comp.nerolidol+Comp.isophytol,
                                         G.NER=Comp.nerolidol,
                                         G.ISO=Comp.isophytol,
                                         G.ALT=`Comp.alpha-terpineol`)

ER_f_mass_group_data <- ER_f_mass_groups %>% select(starts_with("G."))

ER_f_mass_group_data <- ER_f_mass_group_data %>% slice(.,-c(36,44))
ER_f_mass_groups <- ER_f_mass_groups %>% slice(.,-c(36,44))

ER_f_mass_groups <- ER_f_mass_groups %>% select(starts_with("G."), Population, Pop_Plant, Sample_ID, Type) 

All_data_names <- full_join(ER_f_mass_groups, morph_names) %>% filter(Population!="Idaho") %>%  drop_na()

All_data_names$Population<-factor(All_data_names$Population, levels=c("Logan", "Zion", "Inyo", "Arizona"))

model<-lmer(G.LIN~Population+(1|Pop_Plant), data=All_data_names)
hist(resid(model))
plot(predict(model),resid(model))


```

ANOVA:
```{r, echo=FALSE}
a<-anova(model)
a
p.adjust(a$`Pr(>F)`, method="fdr", n=4)

```

Estimated marginal means & contrasts across populations:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
emmeans(model, pairwise~Population, type="response")

emmip(model, ~Population, CIs = TRUE,type="response")+xlab("Population")+ylab("Hypanthium length (estimated marginal mean)")+mdthemes::md_theme_classic()
```



## Part 2: repeatability of floral scent

Floral scent trait as a function of population, with and without plant nested within population as a random effect.

```{r}
ER_f_mass_groups <- ER_f_mass %>% mutate(G.ILE=Comp.2methylbutyronitrile+`Comp.nitro-2-methyl-butane`+`Comp.cis-2-methylbutyraldoxime`+`Comp.trans-2-methylbutyraldoxime`,
                                         G.LEU=Comp.3methylbutyronitrile+`Comp.nitro-3-methyl-butane`+`Comp.cis-3-methylbutyraldoxime`+`Comp.trans-3-methylbutyraldoxime`+`Comp.cis-isobutyraldoxime`+`Comp.trans-isobutyraldoxime`,
                                        
                                         G.PHE=Comp.2phenylethanol+Comp.phenylacetonitrile+Comp.nitrophenylethane+Comp.phenylacetaldoxime,
                                         G.OCI=`Comp.b-myrcene`+`Comp.cis-b-ocimene`+`Comp.trans-b-ocimene`,
                                         G.GER=Comp.citronellol+Comp.neral+Comp.geranial+Comp.nerol+Comp.geraniol,
                                         G.LIN=Comp.linalool,
                                         G.LOX=`Comp.cis-furanoid-linalool-oxide`+`Comp.trans-furanoid-linalool-oxide`+`Comp.pyran-lin-oxide-ketone`+`Comp.cis-pyranoid-linalool-oxide`+`Comp.trans-pyranoid-linalool-oxide`,
                                         G.CAR=`Comp.beta-caryophyllene`+`Comp.alpha-humulene`+`Comp.caryophyllene-oxide`+Comp.farnesol,
                                         G.FAR=`Comp.beta-farnesene`+`Comp.Z-E-alpha-farnesene`+`Comp.E-E-alpha-farnesene`+`Comp.farnesene-epoxide`,
                                         G.SES=Comp.nerolidol+Comp.isophytol,
                                         G.NER=Comp.nerolidol,
                                         G.ISO=Comp.isophytol,
                                         G.ALT=`Comp.alpha-terpineol`)

ER_f_mass_group_data <- ER_f_mass_groups %>% select(starts_with("G."))

ER_f_mass_group_data <- ER_f_mass_group_data %>% slice(.,-c(36,44))
ER_f_mass_groups <- ER_f_mass_groups %>% slice(.,-c(36,44))
```

Trying to implement Hsmc

```{r}
#load libraries
library(readxl)
library(Hmsc)
library(corrplot)

#data wrangling
library(data.table)
library(dplyr)
library(reshape)

#plotting
library(ggplot2)
library(cowplot)
theme_set(theme_cowplot())
library(ggsci)


Y <- as.matrix(ER_f_mass_group_data)

XData <- data.frame(Population      = as.factor(ER_f_mass_groups$Population))   

studyDesign = data.frame(Plant     = as.factor(ER_f_mass_groups$Pop_Plant),
                         Flower = as.factor(ER_f_mass_groups$Flower_ID))

rL1 = HmscRandomLevel(units = levels(studyDesign$Plant     ))    
rL2 = HmscRandomLevel(units = levels(studyDesign$Flower        ))

m = Hmsc(Y=Y, 
         XData       = XData, 
         XFormula    = ~Population,  
         YScale      = T,                               
         distr       = ("normal"),
         studyDesign = studyDesign,
         ranLevels   = list(Plant     = rL1, 
                            Flower         = rL2))

```



Chicken scratch--different approaches:

```{r}

Logan<-ER_f_mass_groups %>% filter(Population=="Idaho") 
Logan_data<-Logan %>% select(starts_with("G.")) 


adon <- adonis(Logan_data~Pop_Plant, data=Logan,permutations=999, method="bray")

adon <- adonis2(ER_f_mass_group_data~Population/Pop_Plant, data=ER_f_mass_groups,permutations=999, method="bray", by="margin")
#I think we can't use strata because not all of the levels of Pop_Plant have the same number of observations in them

install.packages("rptR")

rptGaussian(G.ILE ~ Population + (1|Pop_Plant), "Pop_Plant", data=ER_f_mass_groups)

mod <- lmer(G.ILE ~ Population + (1|Pop_Plant), data=ER_f_mass_groups)
mod.a <- lm(G.ILE ~ Population, data=ER_f_mass_groups)


mod <- lm(G.ILE~Pop_Plant, data=ER_f_mass_groups %>% filter(Population=="Zion"))
mod.a <- lm(G.ILE~1,data=ER_f_mass_groups %>% filter(Population=="Zion"))

anova(mod,mod.a)

Logan<-ER_f_mass_groups %>% filter(Population=="Logan") %>% group_by(Pop_Plant) %>% summarise(N_samples=length(Pop_Plant)) %>%arrange(desc(N_samples)) %>%  kable()
  Logan
 Logan<-ER_f_mass_groups %>% filter(Population=="Logan") ggplot(aes(x=Pop_Plant, y=G.ILE))+geom_point()+ggtitle("Logan")
 Logan
 
Inyo<-ER_f_mass_groups %>% filter(Population=="Inyo") %>% group_by(Pop_Plant) %>% summarise(N_samples=length(Pop_Plant)) %>%arrange(desc(N_samples)) %>%  kable()
 
Inyo
 
 Inyo<-ER_f_mass_groups %>% filter(Population=="Inyo") %>% 
ggplot(aes(x=Pop_Plant, y=G.ILE))+geom_point()+ggtitle("Inyo")
 
 Inyo

Arizona<-ER_f_mass_groups %>% filter(Population=="Arizona") %>% 
ggplot(aes(x=Pop_Plant, y=G.ILE))+geom_point()+ggtitle("Arizona")



Zion <- ER_f_mass_groups %>% filter(Population=="Zion") %>% 
ggplot(aes(x=Pop_Plant, y=G.ILE))+geom_point()+ggtitle("Zion")

Idaho <- ER_f_mass_groups %>% filter(Population=="Idaho") %>% 
ggplot(aes(x=Pop_Plant, y=G.ILE))+geom_point()+ggtitle("Idaho")
  
```






