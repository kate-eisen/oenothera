---
title: "Oenothera correlation heatmaps: sample sizes and keys"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## In this file:

I show a number of correlation heat maps for sets of variables overall, and broken out by population. These were made using only the first flower measured per plant. In some cases, a plant may no longer be represented in the morphology dataset or the morphology + scent dataset if one or more morphological variables were not measured on the first flower. I provide the sample sizes at the beginning of each section.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# need the relevant code from test script in order to be able to knit this file

library(tidyverse)
library(readxl)
library(lme4)
library(lmerTest)
library(emmeans)
library(vegan)
library(knitr)
library(reshape2)
library(ggpubr)

file1<-readxl::read_excel("Scent_Full.xlsx", na="0")
file1<-file1 %>% mutate_all(~replace(.,is.na(.), 0))

file2<-readxl::read_excel("Scent_Meta.xlsx")

file3<-readxl::read_excel("Morph_Full.xlsx")

Totals<-file1 %>% 
  bind_rows(summarise_all(., list(~if(is.numeric(.)) sum(.) else "Comp.Total"))) %>% 
  pivot_longer(cols=starts_with("Samp."),names_to="Sample_ID") %>% 
  pivot_wider(names_from=Compounds, values_from = value)

percent <- function(x) { round((x/sum(x)) * 100, digits=3)
}

Percents<-file1 %>% 
  mutate_at(vars(starts_with("Samp.")), percent)

Percents_wide <- Percents %>% 
  pivot_longer(cols=starts_with("Samp."),names_to="Sample_ID") %>% 
  pivot_wider(names_from=Compounds, values_from = value) %>% 
  full_join(file2)

T_S<-function(Column, Tol.Area, Tol.Amt, Samp.Vol) {
  Column/Tol.Area*Tol.Amt*Samp.Vol
} 

ER_Fm<-function(Total.Samp, Hrs, Fr.Mass) {
  Total.Samp/Hrs/Fr.Mass
}

Total_Samples<-Totals %>%  full_join(file2) %>% 
  mutate_at(vars(starts_with("Comp.")), list(~T_S(.,Toluene_Area,Toluene_Amt, Sample_Vol))) 

ER_f_mass<-Total_Samples %>% 
  mutate_at(vars(starts_with("Comp.")), list(~ER_Fm(.,No_Hours, Fresh_Mass))) 

get_upper_tri <- function(cormat){
    cormat[lower.tri(cormat)]<- NA
    return(cormat)
}

cor.prob <- function(X, dfr = nrow(X) - 2) {
  R <- cor(X)
  above <- row(R) < col(R)
  r2 <- R[above]^2
  Fstat <- r2 * dfr / (1 - r2)
  R[above] <- 1 - pf(Fstat, 1, dfr)
  R
}

flattenSquareMatrix <- function(m) {
  if( (class(m) != "matrix") | (nrow(m) != ncol(m))) stop("Must be a square matrix.") 
  if(!identical(rownames(m), colnames(m))) stop("Row and column names must be equal.")
  ut <- upper.tri(m)
  data.frame(i = rownames(m)[row(m)[ut]],
             j = rownames(m)[col(m)[ut]],
             cor=t(m)[ut],
             p=m[ut])
}

```

## Four types of heatmaps for each population:



### 1. Correlations of scent by compound

*Sample sizes*

Population | *N*
---------- | ---
Total | 76
Arizona | 26
Idaho | 5
Inyo | 15
Logan | 21
Zion | 9

*Key*

[]()      |           
--------- | ---------
1. *ILE* (blue) 2methylbutyronitrile | 21. *GER* (pink purple)  neral        
2. *ILE* (blue) nitro-2-methyl butane | 22. *GER* (pink purple)  geranial           
3. *ILE* (blue) cis-2-methylbutyraldoxime | 23. *GER* (pink purple)  nerol        
4. *ILE* (blue) trans-2-methylbutyraldoxime | 24. *GER* (pink purple)  geraniol               
5. *ILE* (blue) 2methylbutyl benzoate | 25. *LIN* (navy)  linalool
6. *LEU* (pink) 3methylbutyronitrile | 26. *LIN* (navy) cis-furanoid-linalool-oxide
7. *LEU* (pink) nitro-3-methyl-butane | 27. *LIN* (navy) trans-furanoid-linalool-oxide
8. *LEU* (pink) cis-3-methylbutyraldoxime | 28. *LIN* (navy) pyran-lin-oxide-ketone
9. *LEU* (pink) trans-3-methylbutyraldoxime | 29. *LIN* (navy) cis-pyranoid-linalool-oxide
10. *VAL* (goldenrod) cis-isobutyraldoxime | 30. *LIN* (navy) trans-pyranoid-linalool-oxide 
11. *VAL* (goldenrod) trans-isobutyraldoxime | 31. *CAR* (lime green) beta-caryophyllene
12. *PHE* (forest green) 2phenylethanol | 32. *CAR* (lime green) alpha-humulene     
13. *PHE* (forest green) phenylacetonitrile | 33. *CAR* (lime green)caryophyllene-oxide
14. *PHE* (forest green) nitrophenylethane | 34. *SES* (orange)  beta-farnesene
15. *PHE* (forest green) phenylacetaldoxime | 35. *SES* (orange)  Z-E-alpha-farnesene 
16. *OCI* (sky blue) b-myrcene | 36. *SES* (orange)  E-E-alpha-farnesene
17. *OCI* (sky blue) cis-b-ocimene | 37. *SES* (orange) farnesene-epoxide                        
18. *OCI* (sky blue) trans-b-ocimene | 38. *SES* (orange) farnesol            
19. *OCI* (sky blue) alpha-terpineol | 39. *SES* (orange) nerolidol               
20. *GER* (pink purple) citronellol | 40. *SES* (orange) isophytol 

### 2. Correlations of scent by compound group

*Sample sizes*: Sample sizes are the same as for the heatmaps above of all 40 compounds.

*Key*

| Code | Compounds
| :--- | :--------
| G.ILE (blue) | 2 methylbuyronitrile, nitro-2-methyl butane, cis-2-methylbutyraldoxime, trans-2-methylbutyraldoxime, 2methylbutyl benzoate
| G.LEU (pink) | 3methylbutyronitrile, nitro-3-methyl-butane, cis-3-methylbutyraldoxime, trans-3-methylbutyraldoxime
| G.VAL (goldenrod) | cis-isobutyraldoxime, trans-isobutyraldoxime
| G.PHE (forest green) | 2phenylethanol, phenylacetonitrile, nitrophenylethane, phenylacetaldoxime
| G.OCI (sky blue) | b-myrcene, cis-b-ocimene, trans-b-ocimene, alpha-terpineol
| G.GER (pink purple) | citronellol, neral, geranial, nerol, geraniol
| G.LIN (navy) | linalool, cis-furanoid-linalool-oxide, trans-furanoid-linalool-oxide, pyran-lin-oxide-ketone, cis-pyranoid-linalool-oxide, trans-pyranoid-linalool-oxide
| G.CAR (lime green) | beta-caryophyllene, alpha-humulene, caryophyllene-oxide
| G.SES (orange) | beta-farnesene, Z-E-alpha-farnesene, E-E-alpha-farnesene, farnesene-epoxide, farnesol, nerolidol, isophytol

### 3. Correlations of morphology

*Sample sizes* (Note: These values are generally smaller than the scent sample sizes, because a lot of flowers are missing one or more morphology measurements (even after dropping leaf number and leaf length, which were recorded very infrequently), and we can't include a sample in the correlation matrix if it has one or more NAs.)

Population | *N*
---------- | ---
Total | 49
Arizona | 15
Idaho | **3**
Inyo | 12
Logan | 12
Zion | *7*

### 4. Correlations of scent by compound group and morphology

*Sample sizes*:

Population | *N*
---------- | ---
Total | 46
Arizona | 15
Idaho | **3**
Inyo | 11
Logan | 12
Zion | *5*


                                                                   
```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Code that relates to heatmaps of 40 compounds:   
#reordering the compounds:

ER_f_mass_comps <- ER_f_mass %>% select(Comp.2methylbutyronitrile, `Comp.nitro-2-methyl-butane`, `Comp.cis-2-methylbutyraldoxime`, `Comp.trans-2-methylbutyraldoxime`, `Comp.2methylbutyl-benzoate`, Comp.3methylbutyronitrile, `Comp.nitro-3-methyl-butane`, `Comp.cis-3-methylbutyraldoxime`, `Comp.trans-3-methylbutyraldoxime`, `Comp.cis-isobutyraldoxime`, `Comp.trans-isobutyraldoxime`, Comp.2phenylethanol, Comp.phenylacetonitrile, Comp.nitrophenylethane, Comp.phenylacetaldoxime, `Comp.b-myrcene`, `Comp.cis-b-ocimene`, `Comp.trans-b-ocimene`, `Comp.alpha-terpineol`, Comp.citronellol, Comp.neral, Comp.geranial, Comp.nerol, Comp.geraniol, Comp.linalool,  `Comp.cis-furanoid-linalool-oxide`, `Comp.trans-furanoid-linalool-oxide`, `Comp.pyran-lin-oxide-ketone`, `Comp.cis-pyranoid-linalool-oxide`, `Comp.trans-pyranoid-linalool-oxide`, `Comp.beta-caryophyllene`, `Comp.alpha-humulene`, `Comp.caryophyllene-oxide`, `Comp.beta-farnesene`, `Comp.Z-E-alpha-farnesene`, `Comp.E-E-alpha-farnesene`, `Comp.farnesene-epoxide`, `Comp.farnesol`, `Comp.nerolidol`, `Comp.isophytol`, Population, Type)

Arizona <- ER_f_mass_comps %>% filter(Population=="Arizona" & Type=="Yes") %>%  select(starts_with("Comp.")) 
Zion <- ER_f_mass_comps %>% filter(Population=="Zion" & Type=="Yes") %>%  select(starts_with("Comp.")) 
Inyo <- ER_f_mass_comps %>% filter(Population=="Inyo" & Type=="Yes") %>%  select(starts_with("Comp.")) 
Logan <- ER_f_mass_comps %>% filter(Population=="Logan" & Type=="Yes") %>%  select(starts_with("Comp.")) 
Idaho <- ER_f_mass_comps %>% filter(Population=="Idaho" & Type=="Yes") %>%  select(starts_with("Comp.")) 

Tol_ord <- ER_f_mass_comps %>% filter(Type=="Yes") %>% 
  select(starts_with("Comp."), Population) %>% filter_if(is.numeric, any_vars(. != 0)) %>% select(starts_with("Comp.")) 

ps<-flattenSquareMatrix(cor.prob(Inyo))
ps$p.adj<-p.adjust(ps$p, method="fdr")
View(ps)

#
```



```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Code that relates to compound group heatmaps:

ER_f_mass_groups <- ER_f_mass %>% mutate(G.ILE=Comp.2methylbutyronitrile+`Comp.nitro-2-methyl-butane`+`Comp.cis-2-methylbutyraldoxime`+`Comp.trans-2-methylbutyraldoxime`+`Comp.2methylbutyl-benzoate`,
                                         G.LEU=Comp.3methylbutyronitrile+`Comp.nitro-3-methyl-butane`+`Comp.cis-3-methylbutyraldoxime`+`Comp.trans-3-methylbutyraldoxime`,
                                         G.VAL=`Comp.cis-isobutyraldoxime`+`Comp.trans-isobutyraldoxime`,
                                         G.PHE=Comp.2phenylethanol+Comp.phenylacetonitrile+Comp.nitrophenylethane+Comp.phenylacetaldoxime,
                                         G.OCI=`Comp.b-myrcene`+`Comp.cis-b-ocimene`+`Comp.trans-b-ocimene`+`Comp.alpha-terpineol`,
                                         G.GER=Comp.citronellol+Comp.neral+Comp.geranial+Comp.nerol+Comp.geraniol,
                                         G.LIN=Comp.linalool+`Comp.cis-furanoid-linalool-oxide`+`Comp.trans-furanoid-linalool-oxide`+`Comp.pyran-lin-oxide-ketone`+`Comp.cis-pyranoid-linalool-oxide`+`Comp.trans-pyranoid-linalool-oxide`,
                                         G.CAR=`Comp.beta-caryophyllene`+`Comp.alpha-humulene`+`Comp.caryophyllene-oxide`,
                                         G.SES=`Comp.beta-farnesene`+`Comp.Z-E-alpha-farnesene`+`Comp.E-E-alpha-farnesene`+`Comp.farnesene-epoxide`+Comp.farnesol+Comp.nerolidol+Comp.isophytol)

ER_f_mass_group_data <- ER_f_mass_groups %>% filter(Type=="Yes") %>%  select(starts_with("G."))

ER_f_mass_group_data <- ER_f_mass_group_data %>% slice(.,-c(36,44)) 
ER_f_mass_groups <- ER_f_mass_groups %>% slice(.,-c(36,44)) %>% filter(Type=="Yes")

Arizona.group <- ER_f_mass_groups %>% filter(Population=="Arizona") %>%  select(starts_with("G."))
Zion.group <- ER_f_mass_groups %>% filter(Population=="Zion") %>%  select(starts_with("G."))
Inyo.group <- ER_f_mass_groups %>% filter(Population=="Inyo") %>%  select(starts_with("G."))
Logan.group <- ER_f_mass_groups %>% filter(Population=="Logan") %>%  select(starts_with("G."))
Idaho.group <- ER_f_mass_groups %>% filter(Population=="Idaho") %>%  select(starts_with("G."))

ps<-flattenSquareMatrix(cor.prob(Logan.group))
ps$p.adj<-p.adjust(ps$p, method="fdr")
View(ps)
```



``` {r, echo=FALSE, warning=FALSE, message=FALSE}
#### Heatmaps for the entire dataset, all populations: 
colvec<- c("blue", "blue", "blue","blue","blue", "deeppink","deeppink","deeppink","deeppink", "goldenrod1", "goldenrod1", "forestgreen", "forestgreen","forestgreen","forestgreen", "deepskyblue", "deepskyblue","deepskyblue","deepskyblue","magenta","magenta","magenta","magenta","magenta", "navy","navy","navy","navy","navy","navy","limegreen","limegreen","limegreen","coral1","coral1","coral1","coral1","coral1","coral1","coral1")

cor.prob(Tol_ord)

cormat.all <- round(cor(Tol_ord),2)
melted_cormat.all <- melt(cormat.all)
upper_tri.all <- get_upper_tri(cormat.all)
# Melt the correlation matrix
melted_cormat.all <- melt(upper_tri.all, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.all <- ggplot(melted_cormat.all, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 coord_fixed()+scale_x_discrete(labels=c(1:40))+scale_y_discrete(labels=c(1:40))+
ggtitle("All compounds") +xlab("") +ylab("") + theme(legend.position="bottom") +
  theme(aspect.ratio=2/3)+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))
  


```

```{r, echo=FALSE, warning=FALSE, message=FALSE}

cormat.all.group <- round(cor(ER_f_mass_group_data),2)
melted_cormat.all.group <- melt(cormat.all.group)
upper_tri.all.group <- get_upper_tri(cormat.all.group)
# Melt the correlation matrix
melted_cormat.all.group <- melt(upper_tri.all.group, na.rm = TRUE)
# Create a ggheatmap

colvec<- c("blue", "deeppink", "goldenrod1",  "forestgreen",  "deepskyblue", "magenta", "navy","limegreen","coral1")

ggheatmap.all.group <- ggplot(melted_cormat.all.group, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    hjust = 1))+
 coord_fixed()+
ggtitle("Compound groups") +xlab("") +ylab("")+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))

```





``` {r, echo=FALSE, warning=FALSE, message=FALSE}
#### Heat maps for Arizona
View(cor.prob(Arizona))

colvec<- c("blue", "blue", "blue","blue","blue", "deeppink","deeppink","deeppink","deeppink", "goldenrod1", "goldenrod1", "forestgreen", "forestgreen","forestgreen","forestgreen", "deepskyblue", "deepskyblue","deepskyblue","deepskyblue","magenta","magenta","magenta","magenta","magenta", "navy","navy","navy","navy","navy","navy","limegreen","limegreen","limegreen","coral1","coral1","coral1","coral1","coral1","coral1","coral1")

cormat.AZ <- round(cor(Arizona),2)
melted_cormat.AZ <- melt(cormat.AZ)
upper_tri.AZ <- get_upper_tri(cormat.AZ)
# Melt the correlation matrix
melted_cormat.AZ <- melt(upper_tri.AZ, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.AZ <- ggplot(melted_cormat.AZ, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 coord_fixed()+scale_x_discrete(labels=c(1:40))+scale_y_discrete(labels=c(1:40))+
ggtitle("All compounds") +xlab("") +ylab("") + theme(legend.position="bottom") +
  theme(aspect.ratio=2/3)+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}


colvec<- c("blue", "deeppink", "goldenrod1",  "forestgreen",  "deepskyblue", "magenta", "navy","limegreen","coral1")

View(cor.prob(Arizona.group))

cormat.AZ.group <- round(cor(Arizona.group),2)
melted_cormat.AZ.group <- melt(cormat.AZ.group)
upper_tri.AZ.group <- get_upper_tri(cormat.AZ.group)
# Melt the correlation matrix
melted_cormat.AZ.group <- melt(upper_tri.AZ.group, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.AZ.group <- ggplot(melted_cormat.AZ.group, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed()+
ggtitle("Compound groups") +xlab("") +ylab("")+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))

```


``` {r, echo=FALSE, warning=FALSE, message=FALSE}
#### Heat maps for Zion
colvec<- c("blue", "blue", "blue","blue","blue", "deeppink","deeppink","deeppink","deeppink", "goldenrod1", "goldenrod1", "forestgreen", "forestgreen","forestgreen","forestgreen", "deepskyblue", "deepskyblue","deepskyblue","deepskyblue","magenta","magenta","magenta","magenta","magenta", "navy","navy","navy","navy","navy","navy","limegreen","limegreen","limegreen","coral1","coral1","coral1","coral1","coral1","coral1","coral1")
cormat.ZI <- round(cor(Zion),2)
melted_cormat.ZI <- melt(cormat.ZI)
upper_tri.ZI <- get_upper_tri(cormat.ZI)
# Melt the correlation matrix
melted_cormat.ZI <- melt(upper_tri.ZI, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.ZI <- ggplot(melted_cormat.ZI, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 coord_fixed()+scale_x_discrete(labels=c(1:40))+scale_y_discrete(labels=c(1:40))+
ggtitle("All compounds") +xlab("") +ylab("") + theme(legend.position="bottom") +
  theme(aspect.ratio=2/3)+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}


colvec<- c("blue", "deeppink", "goldenrod1",  "forestgreen",  "deepskyblue", "magenta", "navy","limegreen","coral1")

cormat.ZI.group <- round(cor(Zion.group),2)
melted_cormat.ZI.group <- melt(cormat.ZI.group)
upper_tri.ZI.group <- get_upper_tri(cormat.ZI.group)
# Melt the correlation matrix
melted_cormat.ZI.group <- melt(upper_tri.ZI.group, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.ZI.group <- ggplot(melted_cormat.ZI.group, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed()+
ggtitle("Compound groups") +xlab("") +ylab("")+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))
```


``` {r, echo=FALSE, warning=FALSE, message=FALSE}
#### Heat maps for Inyo
colvec<- c("blue", "blue", "blue","blue","blue", "deeppink","deeppink","deeppink","deeppink", "goldenrod1", "goldenrod1", "forestgreen", "forestgreen","forestgreen","forestgreen", "deepskyblue", "deepskyblue","deepskyblue","deepskyblue","magenta","magenta","magenta","magenta","magenta", "navy","navy","navy","navy","navy","navy","limegreen","limegreen","limegreen","coral1","coral1","coral1","coral1","coral1","coral1","coral1")
cormat.IN <- round(cor(Inyo),2)
melted_cormat.IN <- melt(cormat.IN)
upper_tri.IN <- get_upper_tri(cormat.IN)
# Melt the correlation matrix
melted_cormat.IN <- melt(upper_tri.IN, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.IN <- ggplot(melted_cormat.IN, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 coord_fixed()+scale_x_discrete(labels=c(1:40))+scale_y_discrete(labels=c(1:40))+
ggtitle("All compounds") +xlab("") +ylab("") + theme(legend.position="bottom") +
  theme(aspect.ratio=2/3)+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))

```

```{r, echo=FALSE, warning=FALSE, message=FALSE}


colvec<- c("blue", "deeppink", "goldenrod1",  "forestgreen",  "deepskyblue", "magenta", "navy","limegreen","coral1")

cormat.IN.group <- round(cor(Inyo.group),2)
melted_cormat.IN.group <- melt(cormat.IN.group)
upper_tri.IN.group <- get_upper_tri(cormat.IN.group)
# Melt the correlation matrix
melted_cormat.IN.group <- melt(upper_tri.IN.group, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.IN.group <- ggplot(melted_cormat.IN.group, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed()+
ggtitle("Compound groups") +xlab("") +ylab("")+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))

```


``` {r, echo=FALSE, warning=FALSE, message=FALSE}
#### Heat maps for Logan
colvec<- c("blue", "blue", "blue","blue","blue", "deeppink","deeppink","deeppink","deeppink", "goldenrod1", "goldenrod1", "forestgreen", "forestgreen","forestgreen","forestgreen", "deepskyblue", "deepskyblue","deepskyblue","deepskyblue","magenta","magenta","magenta","magenta","magenta", "navy","navy","navy","navy","navy","navy","limegreen","limegreen","limegreen","coral1","coral1","coral1","coral1","coral1","coral1","coral1")
cormat.LO <- round(cor(Logan),2)
melted_cormat.LO <- melt(cormat.LO)
upper_tri.LO <- get_upper_tri(cormat.LO)
# Melt the correlation matrix
melted_cormat.LO <- melt(upper_tri.LO, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.LO <- ggplot(melted_cormat.LO, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 coord_fixed()+scale_x_discrete(labels=c(1:40))+scale_y_discrete(labels=c(1:40))+
ggtitle("All compounds") +xlab("") +ylab("") + theme(legend.position="bottom") +
  theme(aspect.ratio=2/3)+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))

```

```{r, echo=FALSE, warning=FALSE, message=FALSE}

colvec<- c("blue", "deeppink", "goldenrod1",  "forestgreen",  "deepskyblue", "magenta", "navy","limegreen","coral1")

cormat.LO.group <- round(cor(Logan.group),2)
melted_cormat.LO.group <- melt(cormat.LO.group)
upper_tri.LO.group <- get_upper_tri(cormat.LO.group)
# Melt the correlation matrix
melted_cormat.LO.group <- melt(upper_tri.LO.group, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.LO.group <- ggplot(melted_cormat.LO.group, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed()+
ggtitle("Compound groups") +xlab("") +ylab("")+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))

```


``` {r, echo=FALSE, warning=FALSE, message=FALSE}
#### Heat maps for Idaho

ps<-flattenSquareMatrix(cor.prob(Idaho))
ps$p.adj<-p.adjust(ps$p, method="fdr")
colvec<- c("blue", "blue", "blue","blue","blue", "deeppink","deeppink","deeppink","deeppink", "goldenrod1", "goldenrod1", "forestgreen", "forestgreen","forestgreen","forestgreen", "deepskyblue", "deepskyblue","deepskyblue","deepskyblue","magenta","magenta","magenta","magenta","magenta", "navy","navy","navy","navy","navy","navy","limegreen","limegreen","limegreen","coral1","coral1","coral1","coral1","coral1","coral1","coral1")
cormat.ID <- round(cor(Idaho),2)
melted_cormat.ID <- melt(cormat.ID)
upper_tri.ID <- get_upper_tri(cormat.ID)
# Melt the correlation matrix
melted_cormat.ID <- melt(upper_tri.ID, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.ID <- ggplot(melted_cormat.ID, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 coord_fixed()+scale_x_discrete(labels=c(1:40))+scale_y_discrete(labels=c(1:40))+
ggtitle("All compounds") +xlab("") +ylab("") + theme(legend.position="bottom") +
  theme(aspect.ratio=2/3)+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))

```

```{r, echo=FALSE, warning=FALSE, message=FALSE}

ps<-flattenSquareMatrix(cor.prob(Idaho.group))
ps$p.adj<-p.adjust(ps$p, method="fdr")

colvec<- c("blue", "deeppink", "goldenrod1",  "forestgreen",  "deepskyblue", "magenta", "navy","limegreen","coral1")


cormat.ID.group <- round(cor(Idaho.group),2)
melted_cormat.ID.group <- melt(cormat.ID.group)
upper_tri.ID.group <- get_upper_tri(cormat.ID.group)
# Melt the correlation matrix
melted_cormat.ID.group <- melt(upper_tri.ID.group, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.ID.group <- ggplot(melted_cormat.ID.group, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed()+
ggtitle("Compound groups") +xlab("") +ylab("")+theme(axis.text.x = element_text(color=colvec))+theme(axis.text.y = element_text(color=colvec))


```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
#These are sample sizes for morphology when we are just using the first flower. These values are generally smaller than the scent sample sizes, because a lot of flowers are missing one or more morphology measurements (even after dropping leaf number and leaf length, which were recorded very infrequently), and we can't include a sample in the correlation matrix if it has one or more NAs.
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
### Heatmaps of morphology
Arizona <- file3 %>% filter(Population=="Arizona" & Type=="Yes") %>% select(starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
Zion <- file3 %>% filter(Population=="Zion" & Type=="Yes") %>% select(starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
Inyo <- file3 %>% filter(Population=="Inyo" & Type=="Yes") %>% select(starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
Logan <- file3 %>% filter(Population=="Logan" & Type=="Yes") %>% select(starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
Idaho <- file3 %>% filter(Population=="Idaho" & Type=="Yes") %>% select(starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
morph <- file3 %>% filter(Population!="NA" &Type=="Yes") %>% select(starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()

labels <- c("Cor_D1", "Cor_D2", "Tube_F", "Stam_L", "Sty_L", "Hyp_L", "Ped_L", "Nect_C", "P_Sug")

ps<-flattenSquareMatrix(cor.prob(Zion))
ps$p.adj<-p.adjust(ps$p, method="fdr")
View(ps)

cormat.all <- round(cor(morph),2)
melted_cormat.all <- melt(cormat.all)
upper_tri.all <- get_upper_tri(cormat.all)
# Melt the correlation matrix
melted_cormat.all <- melt(upper_tri.all, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.all.morph <- ggplot(melted_cormat.all, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed()+scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology") +xlab("") +ylab("")

View(cor.prob(Arizona))

cormat.AZ <- round(cor(Arizona),2)
melted_cormat.AZ <- melt(cormat.AZ)
upper_tri.AZ <- get_upper_tri(cormat.AZ)
melted_cormat.AZ <- melt(upper_tri.AZ, na.rm = TRUE)
ggheatmap.AZ.morph <- ggplot(melted_cormat.AZ, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology") +xlab("") +ylab("")

cormat.ZI <- round(cor(Zion),2)
melted_cormat.ZI <- melt(cormat.ZI)
upper_tri.ZI <- get_upper_tri(cormat.ZI)
melted_cormat.ZI <- melt(upper_tri.ZI, na.rm = TRUE)
ggheatmap.ZI.morph <- ggplot(melted_cormat.ZI, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology") +xlab("") +ylab("")

cormat.IN <- round(cor(Inyo),2)
melted_cormat.IN <- melt(cormat.IN)
upper_tri.IN <- get_upper_tri(cormat.IN)
melted_cormat.IN <- melt(upper_tri.IN, na.rm = TRUE)
ggheatmap.IN.morph <- ggplot(melted_cormat.IN, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology") +xlab("") +ylab("")

cormat.LO <- round(cor(Logan),2)
melted_cormat.LO <- melt(cormat.LO)
upper_tri.LO <- get_upper_tri(cormat.LO)
melted_cormat.LO <- melt(upper_tri.LO, na.rm = TRUE)
ggheatmap.LO.morph <- ggplot(melted_cormat.LO, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology") +xlab("") +ylab("")

cormat.ID <- round(cor(Idaho),2)
melted_cormat.ID <- melt(cormat.ID)
upper_tri.ID <- get_upper_tri(cormat.ID)
melted_cormat.ID <- melt(upper_tri.ID, na.rm = TRUE)
ggheatmap.ID.morph <- ggplot(melted_cormat.ID, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology") +xlab("") +ylab("")

```




```{r, echo=FALSE, warning=FALSE, message=FALSE}
### Heatmaps of morphology & scent by compound group
ER_f_mass_group_data <- ER_f_mass_groups %>% select(starts_with("G."), Sample_ID)

morph <- file3 %>% filter(Population!="NA" &Type=="Yes")

scent_morph <- full_join(ER_f_mass_group_data, morph) %>% filter(Population!="NA") %>% filter(G.ILE!="NA")

Arizona <- scent_morph %>% filter(Population=="Arizona") %>%  select(starts_with("G."), starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
Zion <- scent_morph %>% filter(Population=="Zion") %>%  select(starts_with("G."), starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
Inyo <- scent_morph %>% filter(Population=="Inyo") %>%  select(starts_with("G."), starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
Logan <- scent_morph %>% filter(Population=="Logan") %>%  select(starts_with("G."), starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()
Idaho <- scent_morph %>% filter(Population=="Idaho") %>%  select(starts_with("G."), starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()

scent_morph <- scent_morph %>% select(starts_with("G."), starts_with("M.")) %>% select(-"M.Leaf_Number", -"M.Leaf_Length") %>% drop_na()

ps<-flattenSquareMatrix(cor.prob(Inyo))
ps$p.adj<-p.adjust(ps$p, method="fdr")
View(ps)

labels <- c("G.ILE", "G.LEU","G.VAL","G.PHE","G.OCI","G.GER","G.LIN","G.CAR","G.SES", "Cor_D1", "Cor_D2", "Tube_F", "Stam_L", "Sty_L", "Hyp_L", "Ped_L", "Nect_C", "P_Sug")

cormat.all <- round(cor(scent_morph),2)
melted_cormat.all <- melt(cormat.all)
upper_tri.all <- get_upper_tri(cormat.all)
# Melt the correlation matrix
melted_cormat.all <- melt(upper_tri.all, na.rm = TRUE)
# Create a ggheatmap
ggheatmap.all <- ggplot(melted_cormat.all, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
  theme(axis.text.y = element_text(size =6))+
 theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 6, 
     hjust = 1))+
 coord_fixed()+scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology and compound groups") +xlab("") +ylab("")

cormat.AZ <- round(cor(Arizona),2)
melted_cormat.AZ <- melt(cormat.AZ)
upper_tri.AZ <- get_upper_tri(cormat.AZ)
melted_cormat.AZ <- melt(upper_tri.AZ, na.rm = TRUE)
ggheatmap.AZ <- ggplot(melted_cormat.AZ, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.y = element_text(size =6))+
 theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 6, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology and compound groups") +xlab("") +ylab("")

cormat.ZI <- round(cor(Zion),2)
melted_cormat.ZI <- melt(cormat.ZI)
upper_tri.ZI <- get_upper_tri(cormat.ZI)
melted_cormat.ZI <- melt(upper_tri.ZI, na.rm = TRUE)
ggheatmap.ZI <- ggplot(melted_cormat.ZI, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.y = element_text(size =6))+
 theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 6, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology and compound groups") +xlab("") +ylab("")

cormat.IN <- round(cor(Inyo),2)
melted_cormat.IN <- melt(cormat.IN)
upper_tri.IN <- get_upper_tri(cormat.IN)
melted_cormat.IN <- melt(upper_tri.IN, na.rm = TRUE)
ggheatmap.IN <- ggplot(melted_cormat.IN, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.y = element_text(size =6))+
 theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 6, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology and compound groups") +xlab("") +ylab("")

cormat.LO <- round(cor(Logan),2)
melted_cormat.LO <- melt(cormat.LO)
upper_tri.LO <- get_upper_tri(cormat.LO)
melted_cormat.LO <- melt(upper_tri.LO, na.rm = TRUE)
ggheatmap.LO <- ggplot(melted_cormat.LO, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.y = element_text(size =6))+
 theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 6, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology and compound groups") +xlab("") +ylab("")

cormat.ID <- round(cor(Idaho),2)
melted_cormat.ID <- melt(cormat.ID)
upper_tri.ID <- get_upper_tri(cormat.ID)
melted_cormat.ID <- melt(upper_tri.ID, na.rm = TRUE)
ggheatmap.ID <- ggplot(melted_cormat.ID, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+ # minimal theme
 theme(axis.text.y = element_text(size =6))+
 theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 6, 
     hjust = 1))+
 coord_fixed() +scale_x_discrete(labels=labels)+scale_y_discrete(labels=labels)+
ggtitle("Morphology and compound groups") +xlab("") +ylab("")

#ggarrange(ggheatmap.all, ggheatmap.AZ, ggheatmap.IN, ggheatmap.ZI, ggheatmap.LO, ggheatmap.ID, nrow=2, ncol=3, common.legend = TRUE, legend = "bottom")
```


